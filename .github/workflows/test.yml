###############################################################
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
# SPDX-License-Identifier: Apache-2.0
###############################################################

name: Unit Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('ichub-backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies
      run: |
        cd ichub-backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-html flake8
        
    - name: Verify critical imports
      run: |
        cd ichub-backend
        python -c "import sys; print('Python version:', sys.version)"
        python -c "import tractusx_sdk; print('tractusx_sdk version:', tractusx_sdk.__version__)" || echo "tractusx_sdk not available"
        python -c "import pytest; print('pytest version:', pytest.__version__)"
        
    - name: Check Python syntax
      run: |
        cd ichub-backend
        python -m py_compile **/*.py || true
        
    - name: Lint Python code
      run: |
        cd ichub-backend
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        
    - name: Run unit tests
      run: |
        cd ichub-backend
        echo "Running all unit tests..."
        PYTHONPATH=. python -m pytest tests/ -v --tb=short --maxfail=5
        
    - name: Run tests with coverage
      if: success() || failure()
      run: |
        cd ichub-backend
        echo "Running all backend tests..."
        PYTHONPATH=. python -m pytest tests/ -v --tb=short --cov=. --cov-report=xml --cov-report=html --junit-xml=test-results.xml || true
        
    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
      with:
        name: backend-coverage
        path: |
          ichub-backend/coverage.xml
          ichub-backend/htmlcov/
          
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
      with:
        name: backend-test-results
        path: ichub-backend/test-results.xml

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [backend-tests]
    if: always()
    
    steps:
    - name: Generate summary content
      id: summary-content
      run: |
        echo "# ðŸ§ª Industry Core Hub - Test Results" > summary.md
        echo "" >> summary.md
        echo "**Branch:** \`${{ github.ref_name }}\`" >> summary.md
        echo "**Commit:** \`${{ github.sha }}\`" >> summary.md
        echo "**Triggered by:** ${{ github.event_name }}" >> summary.md
        echo "" >> summary.md
        
        echo "## ðŸ“Š Test Summary" >> summary.md
        echo "" >> summary.md
        echo "| Component | Status | Details |" >> summary.md
        echo "|-----------|--------|---------|" >> summary.md
        echo "| Backend Tests | ${{ needs.backend-tests.result }} | Unit tests, integration tests, and coverage |" >> summary.md
        echo "" >> summary.md
        if [[ "${{ needs.backend-tests.result }}" == "success" ]]; then
          echo "## ðŸŽ‰ Overall Status: SUCCESS" >> summary.md
          echo "All tests passed successfully! The code is ready for review/merge." >> summary.md
        else
          echo "## âš ï¸ Overall Status: ATTENTION NEEDED" >> summary.md
          echo "Some checks failed. Please review the individual job logs for detailed information." >> summary.md
        fi
        echo "summary_path=summary.md" >> $GITHUB_OUTPUT

    - name: Write to Job Summary
      run: cat ${{ steps.summary-content.outputs.summary_path }} >> $GITHUB_STEP_SUMMARY

    - name: Post summary to Pull Request
      if: github.event_name == 'pull_request'
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        body-path: ${{ steps.summary-content.outputs.summary_path }}
        edit-mode: replace
